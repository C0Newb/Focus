<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Register - CNCO</title>
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
		
		<!-- Bootstrap -->
		<link href="css/bootstrap-4.3.1.css" rel="stylesheet">
		<link href="css/login-style.css" rel="stylesheet">
	
	</head>

	<body id="login-bg">
		<div id="register-container">
			<!-- -->
			<form target="_self" action="user/register" method="POST">
				<h1 id="login-header">Welcome new user</h1>
				<span id="login-message"></span>
				<div style="height: 50px;"></div>
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input">
					<input class="mdl-textfield__input" type="username" name="username" id="username" pattern="[a-zA-Z0-9_.]{3,}" maxlength="25" required>
					<label class="mdl-textfield__label" for="username">Username</label>
					<span class="mdl-textfield__error" for="username" id="usernameError">Username must be at least 3, but no more than 25, characters. (No special characters)</span>
				</div>
				<br/>
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input">
					<input class="mdl-textfield__input" type="password" name="password" id="password" pattern=".{4,}" required>
					<label class="mdl-textfield__label" for="password">Password</label>
					<span class="mdl-textfield__error" for="password" id="passwordError">Password must be at least 4 characters.<span>
				</div>
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input">
					<input class="mdl-textfield__input" type="password" name="passwordConf" id="passwordConf" pattern=".{4,}" required>
					<label class="mdl-textfield__label" for="passwordConf">Confirm password</label>
					<span class="mdl-textfield__error" for="password" id="passwordConfError">Password must be at least 4 characters.<span>
				</div>
				
				<div style="height: 5px;">
				</div>
				
				<!-- Personal details -->
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input--halfed login-input--left">
					<input class="mdl-textfield__input" type="text" name="firstName" id="firstName" pattern="[a-zA-Z_.]{1,}" required>
					<label class="mdl-textfield__label" for="firstName">First name</label>
					<span class="mdl-textfield__error" for="firstName">Names can only include a-z and "."</span>
				</div>
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input--halfed login-input--right">
					<input class="mdl-textfield__input" type="text" name="lastName" id="lastName" pattern="[a-zA-Z_.]{1,}">
					<label class="mdl-textfield__label" for="lastName">Last name</label>
				</div>
				
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label login-input">
					<input class="mdl-textfield__input" type="tel" name="phoneNumber" id="phoneNumber" pattern="[0-9]{10}" required>
					<label class="mdl-textfield__label" for="phoneNumber">Phone number (required for password recovery).</label>
					<span class="mdl-textfield__error" for="phoneNumber">Phone numbers must be in this format: 213-423-4253</span>
				</div>
				
				<div style="height: 25px;"></div>
				<input id="sendoff" value="Register" type="submit" class="mdl-button mdl-js-button mdl-js-ripple-effect"/>
			</form>
		</div>

		<script src="js/jquery-3.3.1.min.js"></script>

		<script>
			// check params
			$('#login-message').hide();
			const urlParams = new URLSearchParams(window.location.search);
			const myParam = urlParams.get('failure');
			if(myParam == "username_taken") {
				$('#login-message').show();
				$("#login-message").text("That username was taken, try again.");
			} else if (myParam == "missing_fields") {
				$('#login-message').show();
				$("#login-message").text("Missing required fields. Did you fill in all the fields?");
			} else if (myParam == "username_tooShort") {
				$('#login-message').show();
				$("#login-message").text("Username was too short, make it longer than 3 characters.");

			} else if (myParam == "username_tooLong") {
				$('#login-message').show();
				$("#login-message").text("Username was too long, keep it under 25 characters.");

			} else if (myParam == "password_tooShort") {
				$('#login-message').show();
				$("#login-message").text("Your password was too short, try again.");
			
			} else if (myParam == "password_noMatch") {
				$('#login-message').show();
				$("#login-message").text("Passwords did not match.");

			} else if (myParam == "phoneNumber_format") {
				$('#login-message').show();
				$("#login-message").text("Your phone number does not follow the required format.");

			}

			// username_tooShort, username_tooLong

			passwordCheck = function() {
				if ($("#password").val() != $("#passwordConf").val()) {
					$("#passwordError").text("Passwords must match.");
					$("#passwordErrorConf").text("Passwords must match.");
					$("#passwordError").css("visibility","visible");
					$("#passwordErrorConf").css("visibility","visible");
					window.otherMessage = true;
				} else {
					if (window.otherMessage) {
						$("#passwordError").text("Password must be at least 4 characters.");
						$("#passwordErrorConf").text("Password must be at least 4 characters.");
						$("#passwordError").css("visibility","hidden");
						$("#passwordErrorConf").css("visibility","hidden");
						window.otherMessage = false;
					}
				}
			}
			$("#password").on("input", passwordCheck);
			$("#passwordConf").on("input", passwordCheck);


			$("#username").on("input propertychange", (event) => {
				if (window.otherMessage2) {
					$("#usernameError").text("Username must be at least 3, but no more than 25, characters. (No special characters)");
					$("#usernameError").css("visibility","hidden");
				}

				if (window.event && event.type == "propertychange" && event.propertyName != "value")
					return;
				

				window.clearTimeout($(this).data("timeout"));
				$(this).data("timeout", setTimeout(function() {
					// Send the ajax request
					var username = $("#username").val();
					$.ajax({
						url: '/user/validateUser',
						contentType: "application/json; charset=utf-8",
    					// dataType: "json",
						method: 'POST',
						type: 'POST',
						data: JSON.stringify({ username: username }),
						success: (data) => {
							// strip the data, (just use the second line since the first line is known trash)
							data = data.split('\n');
							data = JSON.parse(data[1]);


							function invalid(reason) {
								$("#usernameError").text(reason);
								$("#usernameError").css("visibility","visible");
								$("#usernameError").css("color","#d50000");
								window.otherMessage2 = true;
							}

							console.log("Username check: ");
							console.log(data);
							if (data.success != true) {
								if (data.reason == "userRegistered") {
									invalid("Username already taken :(");

								} else if (data.reason == "tooShort") {
									invalid("Username is too short.");

								} else if (data.reason == "tooLong") {
									invalid("Username is too long.");

								} else {
									invalid("Username not valid.");

								}	
							} else {
								$("#usernameError").text("Username available!");
								$("#usernameError").css("visibility","visible");
								$("#usernameError").css("color","#00d500");
							}
						},
						error: (msg) => {
							console.log("Oh god! Error checking if the username is taken... Error:");
							console.log(msg);
							$("#usernameError").text("Username *could* be taken, I don't know the lookup failed...");
							$("#usernameError").css("visibility","hidden");
							window.otherMessage2 = true;
						}
					});
				}, 2000));
			});
		</script>


		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<!-- <script src="js/popper.min.js"></script>  -->
		<!-- <script src="js/bootstrap-4.3.1.js"></script> -->
	</body>
</html>